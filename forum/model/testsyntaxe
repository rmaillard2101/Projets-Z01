package main

import (
	"database/sql"
	"fmt"
	"log"
	"time"

	db "forum/model/functions" // ğŸ” Remplace par le chemin correct vers ton package db

	_ "github.com/mattn/go-sqlite3"
)

func main() {
	// Connexion Ã  SQLite en mÃ©moire
	dbConn, err := sql.Open("sqlite3", "./model/forum.db")
	if err != nil {
		log.Fatal(err)
	}
	defer dbConn.Close()

	// CrÃ©ation des tables
	db.Initialisation(dbConn)
	// ğŸ”¹ Insertion 1 : directe
	_, err = db.InsertUser(dbConn, "direct@example.com", "directuser", "pass123")
	if err != nil {
		log.Fatalf("Erreur InsertUser directe: %v", err)
	}

	// ğŸ”¹ Insertion 2 : via goroutine
	insertChan := make(chan db.InsertRequest)
	db.InsertWorker(dbConn, insertChan)

	user := db.User{
		Email:     "gogo@example.com",
		Username:  "gogoroutine",
		Password:  "pass456",
		CreatedAt: time.Now(),
	}

	respChan := make(chan int)
	insertChan <- db.InsertRequest{
		Type:     db.InsertUserType,
		Data:     user,
		RespChan: respChan,
	}

	if <-respChan != 1 {
		log.Fatal("Ã‰chec insertion via goroutine")
	}

	// ğŸ”¹ Fetch all users et print
	users, err := db.FetchUsers(dbConn)
	if err != nil {
		log.Fatalf("Erreur FetchUsers: %v", err)
	}

	fmt.Println("ğŸ‘¥ Utilisateurs en base :")
	fmt.Println(users)

	// Nettoyage
	close(insertChan)
}
